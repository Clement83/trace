services:
  klmtovideo-dev:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: klmtovideo-dev
    ports:
      # Server API port
      - "3001:3001"
      # Vite dev server port (UI hot reload)
      - "5173:5173"
    volumes:
      # Mount entire guiv2 directory for hot reload
      - ./guiv2:/app/guiv2

      # Mount workspace directory to persist user data
      - ./workspace:/app/workspace

      # Mount uploads directory
      - ./uploads:/app/guiv2/server/uploads

      # Use named volumes for node_modules to avoid overwriting
      # This keeps installed packages inside container
      - guiv2-node-modules:/app/guiv2/node_modules
      - guiv2-server-node-modules:/app/guiv2/server/node_modules
      - guiv2-ui-node-modules:/app/guiv2/ui/node_modules

    environment:
      # Application settings
      - NODE_ENV=development
      - PORT=3001

      # SD video generation settings
      - SD_WIDTH=640
      - SD_CRF=28
      - SD_PRESET=veryfast
      - SD_AUDIO_BITRATE=96k

      # Job queue settings
      - MAX_CONCURRENT_JOBS=3
      - JOB_CLEANUP_MS=30000

    working_dir: /app/guiv2

    # Run the dev command from root package.json (concurrently runs server + ui)
    command: sh -c "npm install && npm run install:all && npm run dev"

    stdin_open: true
    tty: true

    networks:
      - klmtovideo-network

    # Optional resource limits for development
    deploy:
      resources:
        limits:
          cpus: "4.0"
          memory: 4G

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  guiv2-node-modules:
  guiv2-server-node-modules:
  guiv2-ui-node-modules:

networks:
  klmtovideo-network:
    driver: bridge
